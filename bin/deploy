#!/bin/bash

export $(echo $(cat .env | sed 's/#.*//g' | sed 's/\r//g' | xargs) | envsubst)

ssh "$REMOTE_USER"@"$REMOTE_HOST" "mkdir -p $REMOTE_PATH"

# shellcheck disable=SC2046
rsync -var --delete --exclude 'build' --exclude '.git' --exclude '.idea' --exclude 'media' --exclude 'out' . "$REMOTE_USER"@"$REMOTE_HOST":"$REMOTE_PATH"

ssh "$REMOTE_USER"@"$REMOTE_HOST" "cd $REMOTE_PATH && bin/remote/buildAndUpdate"
ssh "$REMOTE_USER"@"$REMOTE_HOST" "sudo -u tomcat ln -s $REMOTE_PATH/media /var/lib/tomcat9/webapps/$REMOTE_USER-java/media"

if [[ "$1" == "log" ]]
then
  ssh "$REMOTE_USER"@"$REMOTE_HOST" "tail -f -n1 /var/log/tomcat9/localhost.*.log"
fi